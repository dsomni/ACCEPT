<!DOCTYPE html>
<html>
    <head>
        <title>Результаты урока</title>

        <meta charset="utf-8">
        <meta name="viewport"
              content="width=device-width, initial-scale=1.0,
              maximum-scale=1.0, minimum-scale=1.0,
              user-scalable=no, minimal-ui">
        <meta name="full-screen" content="yes">

        <link rel="stylesheet" href="/public/css/layout.css" type="text/css">
        </head>
    <body>
        <main>
            <h1>Результаты урока <%= lesson.title %></h1>
            <form class="SearchUI" action=<%= "/lessonresults/" + lesson.identificator + "/default" %>  method="POST">
                <select name="GradeSelector" id = "GradeSelector">
                    <option value="all" selected>Все</option>
                    <% for(var i = 6; i < 12; i++) { %>
                    <option value=<%= i %> ><%= i %></option>
                    <% } %>
                </select>
                <input id="gradeLetter" name="gradeLetter" placeholder="Литера">
                <input id="gradeLetter" name="Group" placeholder="Группа">
                <button id="submitsearch">Найти</button>
            </form>

            <table class='taskslist'>
                <tr>
                    <th>Логин</th>
                    <th>Имя</th>
                    <th>Класс</th>
                    <th>Группа</th>
                    <th>Вердикт</th>
                </tr>

                <% for (var i = 0; i < results.length; i++) {
                    let student = results[i][0];%>
                     <tr>
                      <td><a class="tlrefs" href=<%="/account/" + student.login + "/1/" + "default&all" %> > <%=student.login%></a></td>
                      <td><%= student.name %></td>
                      <td><%= student.grade.toString()+student.gradeLetter.toString() %></td>
                      <td><%= student.group %></td>
                      <td><a class="tlrefs" href=<%="/lesson/" + student.login + "/" + ID %> ><%= results[i][1] %></a></td>
                     </tr>
                <% } %>
            </table>
        </main>
    <script>
        let min = (a, b) => {if(a>b)return b;return a;};
        function update(ids) {
            fetch("/api/tournament/get/results/").then(response=>response.json()).then(response => {
                let text = "<tr>\n<th>ID</th>\n<th>Урок</th>\n<th>Класс</th>\n<th>Автор</th>\n<th>Вердикт</th>\n</tr>";
                let lessons = response.lessons;
                let verdicts = response.verdicts;
                for(let i=0; i<min(lessons.length, verdicts.length); i++){
                    let authorArray = lessons[i].author.split(' ');
                    let author = authorArray[0];
                    for(let i=1;i< authorArray.length;i++){
                        if(authorArray[i].length!=0){
                            author += ' '+ authorArray[i][0]+'.';
                        }
                    }
                    text+=`\n<tr>\n<td>${parseInt(lessons[i].identificator)+1}</td>\n<td><a class="tlrefs" href="/lesson/<%= login %>/${lessons[i].identificator}">${lessons[i].title}</a></td>\n<td>${lessons[i].grade}</td>\n<td>${author}</td>\n<td>${verdicts[i]}</td>\n</tr>`
                }
                resultsarea.innerHTML = text;
            }).catch(err => console.log(err));
        }
        let resultsarea = document.getElementById("table");
        let ids = "<%= ids %>"
        update(ids);
        setInterval(() => {
            update(ids);
        }, 5000);
    </script>
</html>